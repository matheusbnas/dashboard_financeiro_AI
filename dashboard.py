import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import os
import glob
from datetime import datetime, timedelta
import numpy as np
import re
from pathlib import Path
import uuid

# Configura√ß√£o da p√°gina
st.set_page_config(
    page_title="üí∞ Dashboard Financeiro Avan√ßado",
    page_icon="üí∞",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Estilos CSS personalizados
st.markdown("""
<style>
    /* Tema principal */
    .main-header {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        padding: 2rem;
        border-radius: 10px;
        color: white;
        margin-bottom: 2rem;
        text-align: center;
    }
    
    .metric-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 1.5rem;
        border-radius: 10px;
        color: white;
        margin: 0.5rem 0;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .stMetric > label {
        color: #2c3e50 !important;
        font-weight: bold !important;
    }
    
    .warning-box {
        padding: 1rem;
        border-radius: 5px;
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        margin: 1rem 0;
    }
    
    .success-box {
        padding: 1rem;
        border-radius: 5px;
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        margin: 1rem 0;
    }
    
    .info-box {
        padding: 1rem;
        border-radius: 5px;
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        margin: 1rem 0;
    }
    
    .footer {
        text-align: center;
        padding: 2rem;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        margin-top: 2rem;
    }
</style>
""", unsafe_allow_html=True)

def detect_column_mappings(df):
    """Detecta automaticamente as colunas do CSV baseado em padr√µes comuns"""
    column_mapping = {}
    
    # Detectar coluna de data
    date_patterns = ['data', 'date', 'dt', 'timestamp', 'time']
    for col in df.columns:
        if any(pattern in col.lower() for pattern in date_patterns):
            column_mapping['Data'] = col
            break
    
    # Detectar coluna de valor
    value_patterns = ['valor', 'value', 'amount', 'montante', 'quantia']
    for col in df.columns:
        if any(pattern in col.lower() for pattern in value_patterns):
            column_mapping['Valor'] = col
            break
    
    # Detectar coluna de descri√ß√£o
    desc_patterns = ['descricao', 'descri√ß√£o', 'description', 'memo', 'observacao', 'observa√ß√£o', 'historic']
    for col in df.columns:
        if any(pattern in col.lower() for pattern in desc_patterns):
            column_mapping['Descri√ß√£o'] = col
            break
    
    # Detectar coluna de categoria
    cat_patterns = ['categoria', 'category', 'tipo', 'class']
    for col in df.columns:
        if any(pattern in col.lower() for pattern in cat_patterns):
            column_mapping['Categoria'] = col
            break
    
    # Detectar coluna de ID
    id_patterns = ['id', 'codigo', 'c√≥digo', 'reference', 'ref']
    for col in df.columns:
        if any(pattern in col.lower() for pattern in id_patterns):
            column_mapping['ID'] = col
            break
    
    return column_mapping

@st.cache_data
def load_csv_files():
    """Carrega todos os CSVs da pasta especificada"""
    csv_patterns = [
        "*.csv",
        "data/*.csv", 
        "data/raw/*.csv",
        "extratos/*.csv",
        "uploads/*.csv"
    ]
    
    all_files = []
    for pattern in csv_patterns:
        files = glob.glob(pattern)
        all_files.extend(files)
    
    if not all_files:
        return pd.DataFrame(), []
    
    dfs = []
    loaded_files = []
    
    for file in all_files:
        try:
            # Tentar diferentes encodings
            encodings = ['utf-8', 'latin-1', 'iso-8859-1', 'cp1252']
            separators = [',', ';', '\t']
            df = None
            
            for encoding in encodings:
                for sep in separators:
                    try:
                        df = pd.read_csv(file, encoding=encoding, sep=sep)
                        if len(df.columns) > 1:
                            break
                    except (UnicodeDecodeError, pd.errors.EmptyDataError):
                        continue
                if df is not None and len(df.columns) > 1:
                    break
            
            if df is not None and len(df.columns) > 1:
                df['arquivo_origem'] = os.path.basename(file)
                dfs.append(df)
                loaded_files.append(file)
                
        except Exception as e:
            st.sidebar.error(f"‚ùå {os.path.basename(file)}: {str(e)}")
    
    if dfs:
        combined_df = pd.concat(dfs, ignore_index=True)
        return combined_df, loaded_files
    return pd.DataFrame(), []

def process_financial_data(df):
    """Processa e limpa os dados financeiros"""
    if df.empty:
        return df
    
    # Detectar mapeamento de colunas
    column_mapping = detect_column_mappings(df)
    
    # Aplicar mapeamento se necess√°rio
    df_processed = df.copy()
    for standard_name, actual_name in column_mapping.items():
        if actual_name != standard_name and actual_name in df.columns:
            df_processed[standard_name] = df_processed[actual_name]
    
    # Verificar se temos as colunas essenciais
    essential_columns = ['Data', 'Valor']
    missing_columns = [col for col in essential_columns if col not in df_processed.columns]
    
    if missing_columns:
        st.error(f"‚ö†Ô∏è **Colunas essenciais n√£o encontradas:** {', '.join(missing_columns)}")
        st.write("**Colunas dispon√≠veis no seu CSV:**")
        st.write(list(df.columns))
        st.stop()
    
    # Processar coluna de data
    try:
        df_processed['Data'] = pd.to_datetime(df_processed['Data'], errors='coerce', dayfirst=True)
        df_processed = df_processed.dropna(subset=['Data'])
        
        # Criar colunas de tempo
        df_processed['Mes'] = df_processed['Data'].dt.to_period('M')
        df_processed['Mes_Str'] = df_processed['Data'].dt.strftime('%Y-%m')
        df_processed['Ano'] = df_processed['Data'].dt.year
        df_processed['Mes_Nome'] = df_processed['Data'].dt.strftime('%B')
        df_processed['Dia_Semana'] = df_processed['Data'].dt.strftime('%A')
        
    except Exception as e:
        st.error(f"‚ùå Erro ao processar datas: {e}")
        st.stop()
    
    # Processar valores
    try:
        if df_processed['Valor'].dtype == 'object':
            df_processed['Valor'] = df_processed['Valor'].astype(str)
            df_processed['Valor'] = df_processed['Valor'].str.replace(r'[R$\s]', '', regex=True)
            df_processed['Valor'] = df_processed['Valor'].str.replace(',', '.', regex=False)
        
        df_processed['Valor'] = pd.to_numeric(df_processed['Valor'], errors='coerce')
        df_processed = df_processed.dropna(subset=['Valor'])
        
        # Classificar receitas e despesas
        df_processed['Tipo'] = df_processed['Valor'].apply(lambda x: 'Receita' if x > 0 else 'Despesa')
        df_processed['Valor_Absoluto'] = df_processed['Valor'].abs()
        
    except Exception as e:
        st.error(f"‚ùå Erro ao processar valores: {e}")
        st.stop()
    
    # Limpar descri√ß√µes
    if 'Descri√ß√£o' not in df_processed.columns:
        if any(col for col in df.columns if 'desc' in col.lower()):
            desc_col = next(col for col in df.columns if 'desc' in col.lower())
            df_processed['Descri√ß√£o'] = df_processed[desc_col]
        else:
            df_processed['Descri√ß√£o'] = 'Sem descri√ß√£o'
    
    df_processed['Descri√ß√£o'] = df_processed['Descri√ß√£o'].fillna('Sem descri√ß√£o')
    df_processed['Descri√ß√£o'] = df_processed['Descri√ß√£o'].astype(str).str.strip()
    
    # Preencher categorias faltantes
    if 'Categoria' not in df_processed.columns:
        df_processed['Categoria'] = 'Outros'
    else:
        df_processed['Categoria'] = df_processed['Categoria'].fillna('Outros')
    
    # Identificar custos fixos automaticamente
    df_processed = identify_fixed_costs(df_processed)
    
    # Remover duplicatas se existir coluna ID
    if 'ID' in df_processed.columns:
        df_processed = df_processed.drop_duplicates(subset=['ID'], keep='first')
    
    return df_processed

def reprocess_as_nubank_data(df):
    """Reprocessa dados especificamente para extratos do Nubank (s√≥ despesas)"""
    if df.empty:
        return df
    
    df_nubank = df.copy()
    
    # No Nubank, tudo s√£o despesas - converter valores para absoluto e marcar como despesa
    df_nubank['Valor_Absoluto'] = df_nubank['Valor'].abs()
    df_nubank['Tipo'] = 'Despesa'
    df_nubank['Valor'] = -df_nubank['Valor_Absoluto']  # Manter valores negativos para despesas
    
    # Melhorar a categoriza√ß√£o autom√°tica baseada em descri√ß√µes do Nubank
    df_nubank = improve_nubank_categorization(df_nubank)
    
    return df_nubank

def improve_nubank_categorization(df):
    """Melhora a categoriza√ß√£o espec√≠fica para dados do Nubank"""
    
    # Padr√µes mais espec√≠ficos do Nubank
    nubank_patterns = {
        'Alimenta√ß√£o': [
            'RESTAURANTE', 'LANCHONETE', 'PADARIA', 'PIZZARIA', 'HAMBURGUER', 'SUBWAY',
            'MCDONALDS', 'BURGER KING', 'KFC', 'PIZZA', 'IFOOD', 'UBER EATS', 'RAPPI',
            'BAR ', 'CAFE', 'CAFETERIA', 'A√áOUGUE', 'SORVETERIA', 'PARRILLA'
        ],
        'Mercado': [
            'SUPERMERCADO', 'MERCADO', 'ATACADAO', 'CARREFOUR', 'EXTRA', 'WALMART',
            'BISTEK', 'ZAFFARI', 'COMERCIAL', 'MERCEARIA', 'HIPERMERCADO', 'BIG',
            'NACIONAL', 'ANGELONI', 'CONDOR'
        ],
        'Transporte': [
            'POSTO', 'COMBUSTIVEL', 'SHELL', 'PETROBRAS', 'IPIRANGA', 'BR DISTRIBUIDORA',
            'UBER', 'TAXI', '99', 'ONIBUS', 'METRO', 'ESTACIONAMENTO', 'PED√ÅGIO',
            'AUTOPASS', 'SEM PARAR', 'OFICINA', 'MECANICA'
        ],
        'Sa√∫de': [
            'FARMACIA', 'DROGARIA', 'PANVEL', 'DROGASIL', 'PACHECO', 'UNIMED',
            'MEDICO', 'HOSPITAL', 'CLINICA', 'LABORATORIO', 'DENTISTA', 'FISIOTERAPEUTA',
            'PAGUE MENOS', 'ULTRAFARMA'
        ],
        'Moradia': [
            'FERREIRA IMOVEIS', 'ALUGUEL', 'CONDOMINIO', 'IPTU', 'COPEL', 'CEMIG',
            'LIGHT', 'ELETROPAULO', 'SABESP', 'SANEPAR', 'COMGAS', 'CEG',
            'LUZ', 'ENERGIA', '√ÅGUA', 'AGUA', 'GAS', 'ESGOTO'
        ],
        'Telefone': [
            'CLARO', 'TIM', 'VIVO', 'OI', 'NET', 'SKY', 'TELEFONICA', 'NEXTEL',
            'TELEFONE', 'CELULAR', 'INTERNET', 'BANDA LARGA'
        ],
        'Educa√ß√£o': [
            'ESCOLA', 'UNIVERSIDADE', 'FACULDADE', 'COLEGIO', 'CURSO', 'MENSALIDADE',
            'LIVROS', 'MATERIAL ESCOLAR', 'PAPELARIA', 'XEROX'
        ],
        'Entretenimento': [
            'NETFLIX', 'SPOTIFY', 'AMAZON PRIME', 'DISNEY', 'GLOBOPLAY', 'YOUTUBE',
            'CINEMA', 'TEATRO', 'SHOW', 'INGRESSO', 'BALADA', 'CLUBE'
        ],
        'Compras': [
            'MAGAZINE', 'SHOPPING', 'LOJA', 'AMERICANAS', 'SUBMARINO', 'MERCADOLIVRE',
            'AMAZON', 'ALIEXPRESS', 'SHOPEE', 'RENNER', 'C&A', 'ZARA', 'H&M'
        ],
        'Servi√ßos': [
            'BANCO', 'CAIXA', 'BRADESCO', 'ITAU', 'SANTANDER', 'NUBANK',
            'CARTORIO', 'DESPACHANTE', 'ADVOCACIA', 'CONTABILIDADE'
        ]
    }
    
    # Aplicar padr√µes espec√≠ficos do Nubank
    for category, patterns in nubank_patterns.items():
        for pattern in patterns:
            mask = df['Descri√ß√£o'].str.contains(pattern, case=False, na=False)
            df.loc[mask, 'Categoria'] = category
    
    return df

def identify_fixed_costs(df):
    """Identifica custos fixos vs vari√°veis"""
    df['Custo_Tipo'] = 'Vari√°vel'
    
    # Padr√µes conhecidos de custos fixos
    fixed_patterns = {
        'Moradia': ['FERREIRA IMOVEIS', 'ALUGUEL', 'CONDOMINIO', 'IPTU', 'LUZ', 'ENERGIA', '√ÅGUA', 'AGUA', 'GAS'],
        'Educa√ß√£o': ['ESCOLA', 'GREMIO NAUTICO', 'MENSALIDADE', 'UNIVERSIDADE', 'FACULDADE', 'CURSO'],
        'Telefone': ['CLARO', 'TIM SA', 'VIVO', 'OI', 'TELEFONE', 'CELULAR', 'INTERNET'],
        'Transfer√™ncias para terceiros': ['COPE SERVICOS', 'CONTABIL', 'PIX PROGRAMADO'],
        'Sa√∫de': ['PLANO DE SAUDE', 'UNIMED', 'BRADESCO SAUDE', 'PLANO SAUDE', 'CONVENIO'],
        'Transporte': ['SEGURO AUTO', 'IPVA', 'LICENCIAMENTO'],
        'Entretenimento': ['NETFLIX', 'SPOTIFY', 'AMAZON PRIME', 'DISNEY', 'GLOBOPLAY']
    }
    
    for categoria, patterns in fixed_patterns.items():
        for pattern in patterns:
            if 'Descri√ß√£o' in df.columns:
                mask = df['Descri√ß√£o'].str.contains(pattern, case=False, na=False)
                df.loc[mask, 'Custo_Tipo'] = 'Fixo'
                df.loc[mask & (df['Categoria'] == 'Outros'), 'Categoria'] = categoria
    
    # Identificar gastos recorrentes (aparecem em pelo menos 3 meses)
    if len(df) > 0 and 'Mes' in df.columns:
        despesas = df[df['Tipo'] == 'Despesa'].copy()
        if not despesas.empty and 'Descri√ß√£o' in despesas.columns:
            freq_descriptions = despesas.groupby('Descri√ß√£o')['Mes'].nunique()
            recurring_descriptions = freq_descriptions[freq_descriptions >= 3].index
            
            mask = df['Descri√ß√£o'].isin(recurring_descriptions) & (df['Tipo'] == 'Despesa')
            df.loc[mask, 'Custo_Tipo'] = 'Fixo'
    
    return df

def create_monthly_analysis(df):
    """Cria an√°lise mensal"""
    if df.empty:
        return pd.DataFrame()
    
    monthly_data = df.groupby(['Mes_Str', 'Tipo']).agg({
        'Valor_Absoluto': 'sum',
        'Data': 'count'
    }).reset_index()
    
    monthly_data.rename(columns={'Data': 'Quantidade'}, inplace=True)
    
    monthly_pivot = monthly_data.pivot(
        index='Mes_Str',
        columns='Tipo',
        values='Valor_Absoluto'
    ).fillna(0)
    
    monthly_pivot['Saldo'] = monthly_pivot.get('Receita', 0) - monthly_pivot.get('Despesa', 0)
    monthly_pivot['Taxa_Poupanca'] = (
        monthly_pivot['Saldo'] / monthly_pivot.get('Receita', 1) * 100
    ).replace([np.inf, -np.inf], 0)
    
    return monthly_pivot.reset_index()

def create_visualizations_nubank(df, monthly_analysis):
    """Cria visualiza√ß√µes espec√≠ficas para dados do Nubank (s√≥ despesas)"""
    
    if monthly_analysis.empty or df.empty:
        return None, None, None, None, None
    
    # 1. Gr√°fico de despesas mensais (sem receitas)
    fig_monthly = go.Figure()
    
    if 'Despesa' in monthly_analysis.columns and monthly_analysis['Despesa'].sum() > 0:
        fig_monthly.add_trace(go.Bar(
            name='Despesas no Cart√£o',
            x=monthly_analysis['Mes_Str'],
            y=monthly_analysis['Despesa'],
            marker_color='#e74c3c',
            hovertemplate='<b>Despesas</b><br>M√™s: %{x}<br>Valor: R$ %{y:,.2f}<extra></extra>'
        ))
        
        # Adicionar linha de tend√™ncia
        if len(monthly_analysis) > 1:
            fig_monthly.add_trace(go.Scatter(
                name='Tend√™ncia',
                x=monthly_analysis['Mes_Str'],
                y=monthly_analysis['Despesa'].rolling(window=2).mean(),
                mode='lines',
                line=dict(color='#3498db', width=2, dash='dash'),
                hovertemplate='<b>M√©dia M√≥vel</b><br>M√™s: %{x}<br>Valor: R$ %{y:,.2f}<extra></extra>'
            ))
    
    fig_monthly.update_layout(
        title='üí∏ Evolu√ß√£o dos Gastos Mensais - Cart√£o Nubank',
        xaxis_title='M√™s',
        yaxis_title='Valor (R$)',
        height=500,
        hovermode='x unified',
        showlegend=True,
        plot_bgcolor='rgba(0,0,0,0)',
        paper_bgcolor='rgba(0,0,0,0)'
    )
    
    # 2. Gr√°fico de pizza por categoria
    despesas_df = df[df['Tipo'] == 'Despesa']
    fig_category = None
    
    if not despesas_df.empty:
        category_data = despesas_df.groupby('Categoria')['Valor_Absoluto'].sum().reset_index()
        category_data = category_data.sort_values('Valor_Absoluto', ascending=False)
        
        if len(category_data) > 0 and category_data['Valor_Absoluto'].sum() > 0:
            fig_category = px.pie(
                category_data, 
                values='Valor_Absoluto', 
                names='Categoria',
                title='üè∑Ô∏è Distribui√ß√£o de Gastos por Categoria - Cart√£o Nubank',
                hole=0.4,
                color_discrete_sequence=px.colors.qualitative.Set3
            )
            fig_category.update_traces(
                textposition='inside', 
                textinfo='percent+label',
                hovertemplate='<b>%{label}</b><br>Valor: R$ %{value:,.2f}<br>Percentual: %{percent}<extra></extra>'
            )
            fig_category.update_layout(
                showlegend=True,
                plot_bgcolor='rgba(0,0,0,0)',
                paper_bgcolor='rgba(0,0,0,0)'
            )
    
    # 3. Custos fixos vs vari√°veis
    fig_fixed_var = None
    if 'Custo_Tipo' in df.columns:
        fixed_var_data = df[df['Tipo'] == 'Despesa'].groupby(['Mes_Str', 'Custo_Tipo'])['Valor_Absoluto'].sum().reset_index()
        
        if not fixed_var_data.empty and len(fixed_var_data) > 0:
            fig_fixed_var = px.bar(
                fixed_var_data,
                x='Mes_Str',
                y='Valor_Absoluto',
                color='Custo_Tipo',
                title='üí° Custos Fixos vs Vari√°veis por M√™s - Cart√£o Nubank',
                color_discrete_map={'Fixo': '#e74c3c', 'Vari√°vel': '#3498db'},
                labels={'Mes_Str': 'M√™s', 'Valor_Absoluto': 'Valor (R$)'}
            )
            fig_fixed_var.update_layout(
                height=400,
                hovermode='x unified',
                showlegend=True,
                plot_bgcolor='rgba(0,0,0,0)',
                paper_bgcolor='rgba(0,0,0,0)'
            )
    
    # 4. Tend√™ncias por categoria (top 6)
    fig_trends = None
    if not despesas_df.empty:
        category_totals = despesas_df.groupby('Categoria')['Valor_Absoluto'].sum()
        top_categories = category_totals.nlargest(6).index
        
        trend_data = despesas_df[
            despesas_df['Categoria'].isin(top_categories)
        ].groupby(['Mes_Str', 'Categoria'])['Valor_Absoluto'].sum().reset_index()
        
        if not trend_data.empty and len(trend_data) > 0:
            fig_trends = px.line(
                trend_data,
                x='Mes_Str',
                y='Valor_Absoluto',
                color='Categoria',
                title='üìà Tend√™ncia dos Gastos por Categoria (Top 6) - Cart√£o Nubank',
                markers=True,
                labels={'Mes_Str': 'M√™s', 'Valor_Absoluto': 'Valor (R$)'},
                color_discrete_sequence=px.colors.qualitative.Set2
            )
            fig_trends.update_layout(
                height=400,
                hovermode='x unified',
                showlegend=True,
                plot_bgcolor='rgba(0,0,0,0)',
                paper_bgcolor='rgba(0,0,0,0)'
            )
    
    # 5. Gauge de economia (baseado na diferen√ßa m√™s a m√™s)
    fig_gauge = None
    if len(monthly_analysis) >= 2:
        current_expense = monthly_analysis['Despesa'].iloc[-1] if 'Despesa' in monthly_analysis.columns else 0
        previous_expense = monthly_analysis['Despesa'].iloc[-2] if 'Despesa' in monthly_analysis.columns else 0
        
        if previous_expense > 0:
            economy_rate = ((previous_expense - current_expense) / previous_expense) * 100
        else:
            economy_rate = 0
        
        fig_gauge = go.Figure(go.Indicator(
            mode="gauge+number+delta",
            value=economy_rate,
            delta={'reference': 0, 'valueformat': '.1f'},
            domain={'x': [0, 1], 'y': [0, 1]},
            title={'text': "Economia vs M√™s Anterior (%)", 'font': {'size': 20}},
            number={'font': {'size': 40}},
            gauge={
                'axis': {'range': [-50, 50], 'tickwidth': 1, 'tickcolor': "darkblue"},
                'bar': {'color': "#2ecc71" if economy_rate >= 0 else "#e74c3c"},
                'bgcolor': "white",
                'borderwidth': 2,
                'bordercolor': "gray",
                'steps': [
                    {'range': [-50, -10], 'color': "#ffebee"},
                    {'range': [-10, 10], 'color': "#fff3e0"},
                    {'range': [10, 50], 'color': "#e8f5e8"}
                ],
                'threshold': {
                    'line': {'color': "blue", 'width': 4},
                    'thickness': 0.75,
                    'value': 0
                }
            }
        ))
        
        fig_gauge.update_layout(
            height=300,
            paper_bgcolor='rgba(0,0,0,0)',
            font={'color': "darkblue", 'family': "Arial"}
        )
    
    return fig_monthly, fig_category, fig_fixed_var, fig_trends, fig_gauge

def create_financial_summary_cards_nubank(df, monthly_analysis):
    """Cria cards de resumo financeiro espec√≠fico para Nubank (s√≥ despesas)"""
    if df.empty or monthly_analysis.empty:
        return
    
    # Calcular m√©tricas do √∫ltimo m√™s (s√≥ despesas)
    latest_month = df['Mes_Str'].max()
    current_month_data = df[df['Mes_Str'] == latest_month]
    
    total_despesas = current_month_data['Valor_Absoluto'].sum()
    num_transacoes = len(current_month_data)
    gasto_medio_transacao = total_despesas / num_transacoes if num_transacoes > 0 else 0
    
    # Custos fixos do m√™s
    if 'Custo_Tipo' in current_month_data.columns:
        custos_fixos = current_month_data[current_month_data['Custo_Tipo'] == 'Fixo']['Valor_Absoluto'].sum()
        custos_variaveis = current_month_data[current_month_data['Custo_Tipo'] == 'Vari√°vel']['Valor_Absoluto'].sum()
    else:
        custos_fixos = 0
        custos_variaveis = total_despesas
    
    # Categoria que mais gastou
    if not current_month_data.empty:
        categoria_top = current_month_data.groupby('Categoria')['Valor_Absoluto'].sum().idxmax()
        valor_categoria_top = current_month_data.groupby('Categoria')['Valor_Absoluto'].sum().max()
    else:
        categoria_top = "N/A"
        valor_categoria_top = 0
    
    # Compara√ß√£o com m√™s anterior
    months = sorted(df['Mes_Str'].unique())
    if len(months) >= 2:
        previous_month = months[-2]
        prev_month_data = df[df['Mes_Str'] == previous_month]
        prev_despesas = prev_month_data['Valor_Absoluto'].sum()
        delta_despesas = total_despesas - prev_despesas
        delta_despesas_pct = (delta_despesas / prev_despesas * 100) if prev_despesas > 0 else 0
    else:
        delta_despesas_pct = 0
    
    # Exibir m√©tricas
    col1, col2, col3, col4, col5 = st.columns(5)
    
    with col1:
        st.metric(
            "üí≥ Total no Cart√£o",
            f"R$ {total_despesas:,.2f}",
            delta=f"{delta_despesas_pct:+.1f}%" if abs(delta_despesas_pct) > 0.1 else None,
            help=f"Total gasto no cart√£o Nubank em {latest_month}"
        )
    
    with col2:
        st.metric(
            "üî¢ Transa√ß√µes",
            f"{num_transacoes}",
            help="N√∫mero total de compras no cart√£o"
        )
    
    with col3:
        st.metric(
            "üìä Gasto M√©dio",
            f"R$ {gasto_medio_transacao:.2f}",
            help="Valor m√©dio por compra no cart√£o"
        )
    
    with col4:
        st.metric(
            "üîí Custos Fixos",
            f"R$ {custos_fixos:,.2f}",
            delta=f"{(custos_fixos/total_despesas*100):.1f}%" if total_despesas > 0 else None,
            help="Gastos fixos pagos no cart√£o"
        )
    
    with col5:
        st.metric(
            f"üèÜ {categoria_top}",
            f"R$ {valor_categoria_top:,.2f}",
            delta=f"{(valor_categoria_top/total_despesas*100):.1f}%" if total_despesas > 0 else None,
            help="Categoria com maior gasto no cart√£o"
        )

def show_expense_titles_analysis(df):
    """Mostra an√°lise detalhada dos t√≠tulos/descri√ß√µes das despesas"""
    st.subheader("üè™ An√°lise Detalhada dos Estabelecimentos - Cart√£o Nubank")
    
    if df.empty:
        st.info("Nenhum dado dispon√≠vel para an√°lise.")
        return
    
    # Estat√≠sticas gerais
    col1, col2, col3 = st.columns(3)
    
    with col1:
        unique_descriptions = df['Descri√ß√£o'].nunique()
        st.metric("üè™ Estabelecimentos √önicos", unique_descriptions)
    
    with col2:
        most_frequent = df['Descri√ß√£o'].mode().iloc[0] if not df['Descri√ß√£o'].mode().empty else "N/A"
        frequency = df['Descri√ß√£o'].value_counts().iloc[0] if len(df) > 0 else 0
        st.metric("üîÑ Mais Usado", f"{frequency}x", delta=most_frequent[:20] + "..." if len(most_frequent) > 20 else most_frequent)
    
    with col3:
        avg_per_establishment = df.groupby('Descri√ß√£o')['Valor_Absoluto'].mean().mean()
        st.metric("üí∞ Gasto M√©dio por Local", f"R$ {avg_per_establishment:.2f}")
    
    # An√°lise por frequ√™ncia
    st.markdown("#### üîÑ Estabelecimentos por Frequ√™ncia de Uso do Cart√£o")
    
    frequency_analysis = df.groupby('Descri√ß√£o').agg({
        'Valor_Absoluto': ['sum', 'mean', 'count'],
        'Data': ['min', 'max']
    }).round(2)
    
    frequency_analysis.columns = ['Total_Gasto', 'Gasto_Medio', 'Frequencia', 'Primeira_Compra', 'Ultima_Compra']
    frequency_analysis = frequency_analysis.sort_values('Frequencia', ascending=False)
    
    # Top 20 mais frequentes
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("##### üèÜ Top 10 - Mais Usados no Cart√£o")
        top_frequent = frequency_analysis.head(10)
        
        for idx, (desc, row) in enumerate(top_frequent.iterrows(), 1):
            with st.expander(f"{idx}. {desc} ({int(row['Frequencia'])}x)"):
                st.write(f"üí≥ **Total no cart√£o:** R$ {row['Total_Gasto']:,.2f}")
                st.write(f"üìä **Gasto m√©dio:** R$ {row['Gasto_Medio']:,.2f}")
                st.write(f"üìÖ **Primeira compra:** {row['Primeira_Compra'].strftime('%d/%m/%Y')}")
                st.write(f"üìÖ **√öltima compra:** {row['Ultima_Compra'].strftime('%d/%m/%Y')}")
                
                # Calcular frequ√™ncia mensal
                dias_periodo = (row['Ultima_Compra'] - row['Primeira_Compra']).days
                if dias_periodo > 0:
                    freq_mensal = (row['Frequencia'] / dias_periodo) * 30
                    st.write(f"üìà **Frequ√™ncia estimada:** {freq_mensal:.1f}x por m√™s")
    
    with col2:
        st.markdown("##### üí∏ Top 10 - Maiores Gastos no Cart√£o")
        top_expensive = frequency_analysis.sort_values('Total_Gasto', ascending=False).head(10)
        
        for idx, (desc, row) in enumerate(top_expensive.iterrows(), 1):
            with st.expander(f"{idx}. {desc} (R$ {row['Total_Gasto']:,.2f})"):
                st.write(f"üîÑ **Usado:** {int(row['Frequencia'])}x no cart√£o")
                st.write(f"üìä **Gasto m√©dio:** R$ {row['Gasto_Medio']:,.2f}")
                st.write(f"üìÖ **Primeira compra:** {row['Primeira_Compra'].strftime('%d/%m/%Y')}")
                st.write(f"üìÖ **√öltima compra:** {row['Ultima_Compra'].strftime('%d/%m/%Y')}")
                
                # Percentual do total
                total_geral = df['Valor_Absoluto'].sum()
                percentual = (row['Total_Gasto'] / total_geral) * 100
                st.write(f"üìä **Representa:** {percentual:.1f}% do total gasto no cart√£o")
    
    # Busca por estabelecimento
    st.markdown("#### üîç Buscar Estabelecimento Espec√≠fico")
    search_term = st.text_input("Digite o nome do estabelecimento:", placeholder="Ex: SUPERMERCADO, POSTO, RESTAURANTE")
    
    if search_term:
        filtered_descriptions = df[df['Descri√ß√£o'].str.contains(search_term, case=False, na=False)]
        
        if not filtered_descriptions.empty:
            search_results = filtered_descriptions.groupby('Descri√ß√£o').agg({
                'Valor_Absoluto': ['sum', 'mean', 'count'],
                'Data': ['min', 'max']
            }).round(2)
            
            search_results.columns = ['Total_Gasto', 'Gasto_Medio', 'Frequencia', 'Primeira_Compra', 'Ultima_Compra']
            search_results = search_results.sort_values('Total_Gasto', ascending=False)
            
            st.write(f"üéØ **Encontrados {len(search_results)} estabelecimentos com '{search_term}'**")
            
            for desc, row in search_results.iterrows():
                st.write(f"**{desc}**")
                col1, col2, col3, col4 = st.columns(4)
                with col1:
                    st.metric("üí≥ Total", f"R$ {row['Total_Gasto']:,.2f}")
                with col2:
                    st.metric("üìä M√©dia", f"R$ {row['Gasto_Medio']:,.2f}")
                with col3:
                    st.metric("üîÑ Vezes", f"{int(row['Frequencia'])}")
                with col4:
                    st.metric("üìÖ Per√≠odo", f"{row['Primeira_Compra'].strftime('%m/%Y')} - {row['Ultima_Compra'].strftime('%m/%Y')}")
                st.markdown("---")
        else:
            st.info(f"Nenhum estabelecimento encontrado com '{search_term}' nos seus gastos do cart√£o")
    
    # Lista completa com filtros
    st.markdown("#### üìã Lista Completa de Estabelecimentos")
    
    col1, col2, col3 = st.columns(3)
    with col1:
        sort_option = st.selectbox("Ordenar por:", 
            ['Frequ√™ncia (maior)', 'Frequ√™ncia (menor)', 'Total gasto (maior)', 'Total gasto (menor)', 'Alfab√©tica'])
    with col2:
        min_frequency = st.number_input("Frequ√™ncia m√≠nima:", min_value=1, value=1)
    with col3:
        show_count = st.selectbox("Mostrar:", [20, 50, 100, "Todos"])
    
    # Aplicar filtros e ordena√ß√£o
    filtered_data = frequency_analysis[frequency_analysis['Frequencia'] >= min_frequency]
    
    if sort_option == 'Frequ√™ncia (maior)':
        filtered_data = filtered_data.sort_values('Frequencia', ascending=False)
    elif sort_option == 'Frequ√™ncia (menor)':
        filtered_data = filtered_data.sort_values('Frequencia', ascending=True)
    elif sort_option == 'Total gasto (maior)':
        filtered_data = filtered_data.sort_values('Total_Gasto', ascending=False)
    elif sort_option == 'Total gasto (menor)':
        filtered_data = filtered_data.sort_values('Total_Gasto', ascending=True)
    elif sort_option == 'Alfab√©tica':
        filtered_data = filtered_data.sort_index()
    
    if show_count != "Todos":
        filtered_data = filtered_data.head(show_count)
    
    # Exibir tabela formatada
    st.dataframe(
        filtered_data.style.format({
            'Total_Gasto': 'R$ {:.2f}',
            'Gasto_Medio': 'R$ {:.2f}',
            'Frequencia': '{:.0f}',
            'Primeira_Compra': lambda x: x.strftime('%d/%m/%Y'),
            'Ultima_Compra': lambda x: x.strftime('%d/%m/%Y')
        }),
        use_container_width=True,
        height=400
    )

def main():
    """Fun√ß√£o principal do dashboard"""
    
    # DEFINIR PROCESSING_MODE LOGO NO IN√çCIO
    processing_mode = st.sidebar.selectbox(
        "üì± Tipo de Extrato",
        options=["Nubank (S√≥ Despesas)", "Banco Tradicional (Receitas + Despesas)"],
        help="Nubank: trata tudo como despesa\nBanco Tradicional: usa sinais +/- para classificar"
    )
    
    # Header principal
    st.markdown("""
    <div class="main-header">
        <h1>üí∞ Dashboard Financeiro Avan√ßado</h1>
        <p>An√°lise Completa e Inteligente dos seus Gastos Pessoais</p>
    </div>
    """, unsafe_allow_html=True)
    
    # Alerta sobre o modo ativo
    if processing_mode == "Nubank (S√≥ Despesas)":
        st.markdown("""
        <div style="background-color: #d1ecf1; border: 1px solid #bee5eb; padding: 1rem; border-radius: 5px; margin: 1rem 0;">
        <h4>üí≥ Modo Cart√£o Nubank Ativo</h4>
        <p><strong>Todas as transa√ß√µes est√£o sendo tratadas como DESPESAS do cart√£o</strong>, pois no extrato do cart√£o Nubank s√≥ aparecem os <strong>gastos/compras</strong> que voc√™ fez, nunca receitas.</p>
        <ul>
            <li>üè™ <strong>An√°lise de estabelecimentos</strong> - Onde voc√™ mais usa o cart√£o</li>
            <li>üîÑ <strong>Frequ√™ncia de compras</strong> - Quantas vezes comprou em cada lugar</li>
            <li>üí° <strong>Categoriza√ß√£o inteligente</strong> - Baseada em padr√µes do Nubank</li>
            <li>üìä <strong>Gauge de economia</strong> - Compara√ß√£o com m√™s anterior</li>
        </ul>
        <p><em>Para analisar conta corrente completa (receitas + despesas), mude para 'Banco Tradicional'.</em></p>
        </div>
        """, unsafe_allow_html=True)
    
    # Sidebar para configura√ß√µes
    st.sidebar.title("‚öôÔ∏è Configura√ß√µes")
    st.sidebar.markdown("### üìÅ Status dos Arquivos")
    
    # Carregar dados
    with st.spinner("üîÑ Carregando dados..."):
        df, loaded_files = load_csv_files()
    
    if df.empty:
        st.error("‚ö†Ô∏è **Nenhum dado encontrado!**")
        
        st.markdown("""
        <div class="warning-box">
        <h4>üìã Como adicionar dados do seu cart√£o Nubank:</h4>
        <ol>
        <li><strong>Baixe o extrato do cart√£o no app/site do Nubank</strong></li>
        <li><strong>Salve o arquivo CSV em uma das pastas:</strong></li>
        <ul>
            <li>Pasta atual (raiz do projeto)</li>
            <li><code>data/raw/</code></li>
            <li><code>extratos/</code></li>
            <li><code>uploads/</code></li>
        </ul>
        <li><strong>Atualize a p√°gina (F5)</strong></li>
        </ol>
        
        <h4>üìÑ Formato do extrato Nubank:</h4>
        <ul>
            <li><strong>Todas as linhas s√£o gastos</strong> (compras no cart√£o)</li>
            <li><strong>Colunas esperadas:</strong> Data, Valor, Descri√ß√£o</li>
            <li><strong>N√£o h√° receitas</strong> no extrato do cart√£o</li>
        </ul>
        </div>
        """, unsafe_allow_html=True)
        
        # Upload de arquivo
        st.markdown("### üì§ Upload de Extrato do Cart√£o")
        uploaded_file = st.file_uploader("Escolha o arquivo CSV do Nubank", type="csv")
        
        if uploaded_file is not None:
            try:
                upload_dir = "uploads"
                os.makedirs(upload_dir, exist_ok=True)
                file_path = os.path.join(upload_dir, uploaded_file.name)
                
                with open(file_path, "wb") as f:
                    f.write(uploaded_file.getvalue())
                
                st.success(f"‚úÖ Extrato {uploaded_file.name} carregado com sucesso!")
                st.info("üîÑ Atualize a p√°gina para processar o arquivo.")
                
            except Exception as e:
                st.error(f"‚ùå Erro ao carregar arquivo: {e}")
        
        return
    
    # Processar dados
    with st.spinner("üîß Processando dados do cart√£o..."):
        try:
            df = process_financial_data(df)
            
            # Aplicar modo espec√≠fico se for Nubank
            if processing_mode == "Nubank (S√≥ Despesas)":
                df = reprocess_as_nubank_data(df)
                
        except Exception as e:
            st.error(f"‚ùå Erro ao processar dados: {e}")
            st.write("**Detalhes do erro:**")
            st.exception(e)
            return
    
    if df.empty:
        st.error("‚ùå Erro ao processar os dados ou dados inv√°lidos!")
        return
    
    # Informa√ß√µes na sidebar
    st.sidebar.success(f"‚úÖ **{len(df):,}** transa√ß√µes carregadas")
    st.sidebar.info(f"üìÖ **Per√≠odo:** {df['Data'].min().date()} at√© {df['Data'].max().date()}")
    st.sidebar.info(f"üìÅ **Arquivos:** {len(loaded_files)}")
    
    # Informa√ß√µes sobre o modo selecionado
    if processing_mode == "Nubank (S√≥ Despesas)":
        st.sidebar.markdown("""
        <div style="background-color: #e8f4fd; padding: 1rem; border-radius: 5px; margin: 1rem 0;">
        <h4>üí≥ Modo Cart√£o Nubank</h4>
        <p><strong>Caracter√≠sticas:</strong></p>
        <ul>
            <li>‚úÖ Todas as transa√ß√µes = despesas do cart√£o</li>
            <li>‚úÖ An√°lise de estabelecimentos</li>
            <li>‚úÖ Frequ√™ncia de uso por local</li>
            <li>‚úÖ Gauge de economia mensal</li>
        </ul>
        </div>
        """, unsafe_allow_html=True)
    
    # An√°lise mensal
    monthly_analysis = create_monthly_analysis(df)
    
    # Filtros na sidebar
    st.sidebar.markdown("### üîç Filtros")
    
    # Filtro de per√≠odo
    min_date = df['Data'].min().date()
    max_date = df['Data'].max().date()
    
    date_range = st.sidebar.date_input(
        "üìÖ Per√≠odo",
        value=(min_date, max_date),
        min_value=min_date,
        max_value=max_date
    )
    
    # Filtro de categorias
    categories = ['Todas'] + sorted(df['Categoria'].unique().tolist())
    selected_categories = st.sidebar.multiselect(
        "üè∑Ô∏è Categorias",
        options=categories,
        default=['Todas']
    )
    
    # Filtro de valor m√≠nimo
    min_value = st.sidebar.number_input(
        "üí∞ Valor m√≠nimo (R$)",
        min_value=0.0,
        value=0.0,
        step=10.0
    )
    
    # Aplicar filtros
    filtered_df = df.copy()
    
    # Filtro de data
    if len(date_range) == 2:
        start_date, end_date = date_range
        filtered_df = filtered_df[
            (filtered_df['Data'].dt.date >= start_date) &
            (filtered_df['Data'].dt.date <= end_date)
        ]
    
    # Filtro de categoria
    if 'Todas' not in selected_categories and selected_categories:
        filtered_df = filtered_df[filtered_df['Categoria'].isin(selected_categories)]
    
    # Filtro de valor m√≠nimo
    if min_value > 0:
        filtered_df = filtered_df[filtered_df['Valor_Absoluto'] >= min_value]
    
    # Recalcular an√°lise mensal com dados filtrados
    monthly_analysis_filtered = create_monthly_analysis(filtered_df)
    
    # Cards de resumo financeiro
    if not filtered_df.empty and not monthly_analysis_filtered.empty:
        create_financial_summary_cards_nubank(filtered_df, monthly_analysis_filtered)
    
    st.markdown("---")
    
    # Criar visualiza√ß√µes
    if not monthly_analysis_filtered.empty:
        try:
            fig_monthly, fig_category, fig_fixed_var, fig_trends, fig_gauge = create_visualizations_nubank(filtered_df, monthly_analysis_filtered)
        except Exception as e:
            st.error(f"‚ùå Erro ao criar visualiza√ß√µes: {e}")
            fig_monthly = fig_category = fig_fixed_var = fig_trends = fig_gauge = None
        
        # Tabs espec√≠ficas para Nubank
        tab1, tab2, tab3, tab4, tab5, tab6 = st.tabs([
            "üìä Vis√£o Geral", 
            "üí° Custos Fixos vs Vari√°veis", 
            "üìà Tend√™ncias", 
            "üè™ Estabelecimentos",  # Aba espec√≠fica para an√°lise de onde gasta
            "üìã Dados Brutos",
            "üìä Relat√≥rios"
        ])
        
        # Tab 1 - Vis√£o Geral
        with tab1:
            if fig_monthly is not None and fig_gauge is not None:
                col1, col2 = st.columns([2, 1])
                
                with col1:
                    st.plotly_chart(fig_monthly, use_container_width=True, key="monthly_chart")
                
                with col2:
                    st.plotly_chart(fig_gauge, use_container_width=True, key="gauge_chart")
            elif fig_monthly is not None:
                st.plotly_chart(fig_monthly, use_container_width=True, key="monthly_chart_only")
            
            # Gr√°fico de pizza
            if fig_category is not None:
                st.plotly_chart(fig_category, use_container_width=True, key="category_pie_chart")
        
        # Tab 2 - Custos Fixos vs Vari√°veis
        with tab2:
            if fig_fixed_var is not None:
                st.plotly_chart(fig_fixed_var, use_container_width=True, key="fixed_var_chart")
                
                col1, col2 = st.columns(2)
                
                with col1:
                    st.subheader("üîí Custos Fixos Pagos no Cart√£o")
                    if 'Custo_Tipo' in filtered_df.columns:
                        fixed_expenses = filtered_df[
                            filtered_df['Custo_Tipo'] == 'Fixo'
                        ].groupby('Descri√ß√£o')['Valor_Absoluto'].mean().sort_values(ascending=False).head(10)
                        
                        if not fixed_expenses.empty:
                            st.dataframe(
                                fixed_expenses.to_frame('Valor M√©dio').style.format({'Valor M√©dio': 'R$ {:.2f}'}),
                                use_container_width=True
                            )
                        else:
                            st.info("Nenhum custo fixo identificado no cart√£o")
                
                with col2:
                    st.subheader("üìä Distribui√ß√£o dos Gastos")
                    if 'Custo_Tipo' in filtered_df.columns:
                        summary = filtered_df.groupby('Custo_Tipo')['Valor_Absoluto'].agg(['sum', 'mean', 'count'])
                        summary.columns = ['Total', 'M√©dia', 'Quantidade']
                        st.dataframe(
                            summary.style.format({
                                'Total': 'R$ {:.2f}',
                                'M√©dia': 'R$ {:.2f}',
                                'Quantidade': '{:.0f}'
                            }),
                            use_container_width=True
                        )
            else:
                st.info("üí° An√°lise de custos fixos vs vari√°veis n√£o dispon√≠vel para este per√≠odo")
        
        # Tab 3 - Tend√™ncias
        with tab3:
            if fig_trends is not None:
                st.plotly_chart(fig_trends, use_container_width=True, key="trends_chart")
            
            # Top gastos no cart√£o
            st.subheader("üîù Maiores Gastos no Cart√£o do Per√≠odo")
            top_expenses = filtered_df.nlargest(15, 'Valor_Absoluto')
            
            if not top_expenses.empty:
                display_cols = ['Data', 'Descri√ß√£o', 'Categoria', 'Valor_Absoluto']
                if 'Custo_Tipo' in top_expenses.columns:
                    display_cols.append('Custo_Tipo')
                
                st.dataframe(
                    top_expenses[display_cols].style.format({
                        'Data': lambda x: x.strftime('%d/%m/%Y'),
                        'Valor_Absoluto': 'R$ {:.2f}'
                    }),
                    use_container_width=True
                )
        
        # Tab 4 - Estabelecimentos (espec√≠fica do Nubank)
        with tab4:
            show_expense_titles_analysis(filtered_df)
        
        # Tab 5 - Dados Brutos
        with tab5:
            st.subheader("üìã Dados Completos do Cart√£o Nubank")
            
            # Op√ß√µes de visualiza√ß√£o
            col1, col2, col3 = st.columns(3)
            with col1:
                show_all = st.checkbox("Mostrar todos os dados", value=False)
            with col2:
                rows_to_show = st.selectbox("Linhas para mostrar", [50, 100, 200, 500], index=0)
            with col3:
                sort_by = st.selectbox("Ordenar por", ['Data', 'Valor_Absoluto', 'Categoria'])
            
            # Preparar dados para exibi√ß√£o
            display_df = filtered_df.copy()
            
            if not show_all:
                display_df = display_df.head(rows_to_show)
            
            # Ordenar
            if sort_by == 'Data':
                display_df = display_df.sort_values('Data', ascending=False)
            elif sort_by == 'Valor_Absoluto':
                display_df = display_df.sort_values('Valor_Absoluto', ascending=False)
            else:
                display_df = display_df.sort_values(sort_by)
            
            # Exibir
            cols_to_show = ['Data', 'Descri√ß√£o', 'Categoria', 'Valor_Absoluto']
            if 'Custo_Tipo' in display_df.columns:
                cols_to_show.append('Custo_Tipo')
            
            st.dataframe(
                display_df[cols_to_show].style.format({
                    'Data': lambda x: x.strftime('%d/%m/%Y') if pd.notnull(x) else '',
                    'Valor_Absoluto': 'R$ {:.2f}'
                }),
                use_container_width=True,
                height=400
            )
            
            # Bot√£o de download
            csv = filtered_df.to_csv(index=False)
            st.download_button(
                label="üì• Baixar dados do cart√£o (CSV)",
                data=csv,
                file_name=f"gastos_cartao_nubank_{datetime.now().strftime('%Y%m%d')}.csv",
                mime="text/csv"
            )
        
        # Tab 6 - Relat√≥rios
        with tab6:
            st.subheader("üìä Relat√≥rios do Cart√£o Nubank")
            
            report_type = st.selectbox(
                "Tipo de Relat√≥rio",
                ["Mensal Detalhado", "Por Categoria", "Estabelecimentos Frequentes", "Custos Fixos"]
            )
            
            if st.button("üìÑ Gerar Relat√≥rio"):
                if report_type == "Mensal Detalhado":
                    st.write("### üìä Relat√≥rio Mensal - Cart√£o Nubank")
                    
                    for _, row in monthly_analysis_filtered.iterrows():
                        st.write(f"**M√™s: {row['Mes_Str']}**")
                        st.write(f"- Total gasto no cart√£o: R$ {row.get('Despesa', 0):,.2f}")
                        
                        # Calcular n√∫mero de transa√ß√µes no m√™s
                        month_transactions = filtered_df[filtered_df['Mes_Str'] == row['Mes_Str']]
                        st.write(f"- Compras realizadas: {len(month_transactions)}")
                        if len(month_transactions) > 0:
                            st.write(f"- Gasto m√©dio por compra: R$ {row.get('Despesa', 0)/len(month_transactions):,.2f}")
                        st.write("---")
                
                elif report_type == "Estabelecimentos Frequentes":
                    st.write("### üè™ Relat√≥rio de Estabelecimentos - Cart√£o Nubank")
                    
                    establishment_report = filtered_df.groupby('Descri√ß√£o').agg({
                        'Valor_Absoluto': ['sum', 'mean', 'count'],
                        'Data': ['min', 'max']
                    }).round(2)
                    
                    establishment_report.columns = ['Total_Gasto', 'Gasto_Medio', 'Frequencia', 'Primeira_Compra', 'Ultima_Compra']
                    establishment_report = establishment_report.sort_values('Frequencia', ascending=False).head(20)
                    
                    for desc, row in establishment_report.iterrows():
                        st.write(f"**{desc}**")
                        st.write(f"- Compras no cart√£o: {int(row['Frequencia'])} vezes")
                        st.write(f"- Total gasto: R$ {row['Total_Gasto']:,.2f}")
                        st.write(f"- Gasto m√©dio por compra: R$ {row['Gasto_Medio']:,.2f}")
                        st.write(f"- Primeira compra: {row['Primeira_Compra'].strftime('%d/%m/%Y')}")
                        st.write(f"- √öltima compra: {row['Ultima_Compra'].strftime('%d/%m/%Y')}")
                        st.write("---")
                
                elif report_type == "Por Categoria":
                    st.write("### üè∑Ô∏è Relat√≥rio por Categoria - Cart√£o Nubank")
                    
                    category_report = filtered_df.groupby('Categoria').agg({
                        'Valor_Absoluto': ['sum', 'mean', 'count'],
                        'Data': ['min', 'max']
                    }).round(2)
                    
                    for categoria in category_report.index:
                        st.write(f"**{categoria}**")
                        st.write(f"- Total no cart√£o: R$ {category_report.loc[categoria, ('Valor_Absoluto', 'sum')]:,.2f}")
                        st.write(f"- Gasto m√©dio: R$ {category_report.loc[categoria, ('Valor_Absoluto', 'mean')]:,.2f}")
                        st.write(f"- N√∫mero de compras: {category_report.loc[categoria, ('Valor_Absoluto', 'count')]:.0f}")
                        st.write("---")
                
                # Bot√£o para exportar relat√≥rio
                st.download_button(
                    label="üì• Baixar Relat√≥rio (TXT)",
                    data=f"Relat√≥rio {report_type} - Cart√£o Nubank\nGerado em {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}",
                    file_name=f"relatorio_cartao_nubank_{report_type.lower().replace(' ', '_')}_{datetime.now().strftime('%Y%m%d')}.txt",
                    mime="text/plain"
                )
    
    else:
        st.warning("‚ö†Ô∏è N√£o foi poss√≠vel gerar as visualiza√ß√µes. Verifique se h√° dados suficientes.")
    
    # Footer
    st.markdown("""
    <div class="footer">
        <h3>üí≥ Dashboard Cart√£o Nubank</h3>
        <p>An√°lise especializada para extratos do cart√£o Nubank | üîí Dados processados localmente</p>
        <p>Vers√£o 3.0 - Otimizada para cart√£o de cr√©dito/d√©bito</p>
    </div>
    """, unsafe_allow_html=True)

if __name__ == "__main__":
    main()